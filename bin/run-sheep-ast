#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'sheep_ast'
require 'benchmark'

module SheepAst
  # TBD
  class Run
    include SheepAst::Option

    # rubocop:disable all
    def run
      prog = __FILE__.to_s.split('/').last

      optparse = option_on
      argv = ARGV.dup

      option = option_parse(argv)

      current_dir = Dir.pwd

      puts "#{prog}> Executing on"
      puts "#{prog}>   version: #{SheepAst::VERSION}"
      puts "#{prog}>   ruby version: #{ruby_version}"
      puts "#{prog}>   current dir: #{current_dir}"

      exit_status = false
      time = nil

      core = SheepAst::AnalyzerCore.new

      ret = do_configure(core, option, optparse)
      if ret
        if !argv.empty?
          time = Benchmark.measure {
            exit_status = core.report(raise: false) {
              puts "#{prog}> Do analyze"
              core.analyze_file(argv) unless argv.empty?
            }
          }

          if !exit_status
            puts 'ERROR: Exception is happened in the analyzer core'
          end
        else
          puts "#{prog}> Files are not given to argv."
        end
      end

      puts "#{prog}> Time to process : #{time.real}" unless time.nil?


      begin
        puts "#{prog}> Successfully processed. Call handle_result."
        method(:handle_result).call(core)
      rescue NameError => e
        puts 'handle_result is not loaded'
        p e
        puts e.backtrace
      rescue => e
        puts 'Unknown ERROR abort'
        p e
        puts e.backtrace
      end

      puts "#{prog}> Finish. Thank you."
      exit(exit_status)
    end
  end
end

if __FILE__ == $PROGRAM_NAME
  prog = SheepAst::Run.new
  prog.run
end
